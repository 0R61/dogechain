//nolint:lll
package upgrader

import (
	"fmt"
	"math/big"

	"github.com/dogechain-lab/dogechain/chain"
	"github.com/dogechain-lab/dogechain/contracts/systemcontracts"
	"github.com/dogechain-lab/dogechain/helper/hex"
	"github.com/dogechain-lab/dogechain/state"
	"github.com/dogechain-lab/dogechain/types"
	"github.com/hashicorp/go-hclog"
)

type UpgradeConfig struct {
	ContractAddr       types.Address
	CommitURL          string
	Code               string
	DefaultInitStorage map[types.Hash]types.Hash  // the initial storage must be backward compatible
	Rebalance          map[types.Address]*big.Int // deprecated, only active in test network
}

type Upgrade struct {
	UpgradeName string
	Configs     []*UpgradeConfig
}

// type upgradeHook func(blockNumber uint64, contractAddr types.Address, statedb *state.State) error

const (
	MainNetChainID = 2000
	DevNetChainID  = 668
)

const (
	mainNet = "Mainnet"
	devNet  = "Devnet"
)

var (
	GenesisHash types.Hash
	//upgrade config
	// pre-portland. deprecated in devnet
	_prePortlandUpgrade = make(map[string]*Upgrade)
	// portland
	_portlandUpgrade = make(map[string]*Upgrade)
	// detroit
	_detroitUpgrade = make(map[string]*Upgrade)
)

func init() {
	// pre-portland upgrade
	_testInt, _ := new(big.Int).SetString("55000000000000000000", 0)
	_prePortlandUpgradeContent := &Upgrade{
		UpgradeName: "pre-portland",
		Configs: []*UpgradeConfig{
			{
				Rebalance: map[types.Address]*big.Int{
					types.StringToAddress("0x1b051e5D1548326284493BfA380E02C3C149Da4E"): _testInt,
					types.StringToAddress("0xa516CF76d083b4cBe93Ebdfb85FbE72aFfFb7a0c"): big.NewInt(0),
					types.StringToAddress("0xC7aD3276180f8dfb628d975473a81Af2836CDf2b"): big.NewInt(0),
					types.StringToAddress("0x521299a363f1847863e4a6c68c91df722d149c3b"): big.NewInt(0),
					types.StringToAddress("0x3a9185A6b49617cC2d5BE65aF199B73f24834F4f"): big.NewInt(0),
				},
			},
		},
	}
	// network supports pre-portland hardfork
	_prePortlandUpgrade[devNet] = _prePortlandUpgradeContent

	// portland upgrade
	_portlandUpgradeCfg := &Upgrade{
		UpgradeName: "portland",
		Configs: []*UpgradeConfig{
			{
				ContractAddr: systemcontracts.AddrBridgeContract,
				CommitURL:    "https://github.com/dogechain-lab/contracts/commit/bcaad0a8a050743855d294d58dac73f06fdc9585",
				Code:         "6080604052600436106101085760003560e01c8063715018a6116100955780639dc29fac116100645780639dc29fac14610321578063cd86a6cb1461034a578063d91921ed14610387578063eb12d61e146103b0578063f2fde38b146103d957610108565b8063715018a6146102775780637df73e271461028e5780638da5cb5b146102cb57806394cf795e146102f657610108565b806331fb67c2116100dc57806331fb67c2146101b557806334fcf437146101d15780634cde3a53146101fa57806354c4633e1461022557806367058d291461024e57610108565b8062a8efc71461010d57806318160ddd1461013657806319e5c034146101615780632c4e722e1461018a575b600080fd5b34801561011957600080fd5b50610134600480360381019061012f919061198e565b610402565b005b34801561014257600080fd5b5061014b6104ae565b6040516101589190611d88565b60405180910390f35b34801561016d57600080fd5b50610188600480360381019061018391906118a6565b6104b8565b005b34801561019657600080fd5b5061019f61082a565b6040516101ac9190611d88565b60405180910390f35b6101cf60048036038101906101ca9190611945565b610834565b005b3480156101dd57600080fd5b506101f860048036038101906101f3919061198e565b61092d565b005b34801561020657600080fd5b5061020f610a12565b60405161021c9190611d88565b60405180910390f35b34801561023157600080fd5b5061024c60048036038101906102479190611839565b610a1c565b005b34801561025a57600080fd5b506102756004803603810190610270919061198e565b610b63565b005b34801561028357600080fd5b5061028c610c48565b005b34801561029a57600080fd5b506102b560048036038101906102b09190611839565b610ce2565b6040516102c29190611c94565b60405180910390f35b3480156102d757600080fd5b506102e0610d38565b6040516102ed9190611c57565b60405180910390f35b34801561030257600080fd5b5061030b610d61565b6040516103189190611c72565b60405180910390f35b34801561032d57600080fd5b5061034860048036038101906103439190611866565b610def565b005b34801561035657600080fd5b50610371600480360381019061036c91906118a6565b610ee0565b60405161037e9190611c72565b60405180910390f35b34801561039357600080fd5b506103ae60048036038101906103a9919061198e565b610fb9565b005b3480156103bc57600080fd5b506103d760048036038101906103d29190611839565b611065565b005b3480156103e557600080fd5b5061040060048036038101906103fb9190611839565b6112a6565b005b3373ffffffffffffffffffffffffffffffffffffffff1660008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610490576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161048790611d28565b60405180910390fd5b6104a5816006546113b090919063ffffffff16565b60068190555050565b6000600654905090565b600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16610544576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161053b90611d68565b60405180910390fd5b60008484848460405160200161055d9493929190611c11565b60405160208183030381529060405280519060200120905060006005600083815260200190815260200160002090508060040160149054906101000a900460ff16156105aa575050610824565b60005b816000018054905081101561064b573373ffffffffffffffffffffffffffffffffffffffff168260000182815481106105e9576105e86121a3565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141561063857505050610824565b808061064390612070565b9150506105ad565b50858160040160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550848160010181905550828160030190805190602001906106b09291906116fc565b50838160020190805190602001906106c99291906116fc565b5080600001339080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600280805490506107409190611ec4565b816000018054905011801561076457508060040160149054906101000a900460ff16155b156108215760018160040160146101000a81548160ff02191690831515021790555061079b856006546113c690919063ffffffff16565b60068190555080600101548160040160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167fbceab28ca952a9177ce3716580d6c8c2d677fdf721b944e57a5e7322622ffdc98360020184600301604051610818929190611cd1565b60405180910390a35b50505b50505050565b6000600754905090565b600154341015610879576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161087090611d48565b60405180910390fd5b60006108a4612710610896600754346113dc90919063ffffffff16565b6113f290919063ffffffff16565b905060006108bb82346113b090919063ffffffff16565b90506108d2816006546113b090919063ffffffff16565b60068190555081813373ffffffffffffffffffffffffffffffffffffffff167f62116a798bb58cc967874bea4d771de2f9aeec6c64189ff2e5a551072f3106f9866040516109209190611caf565b60405180910390a4505050565b3373ffffffffffffffffffffffffffffffffffffffff1660008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146109bb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109b290611d28565b60405180910390fd5b600060075490508160078190555081813373ffffffffffffffffffffffffffffffffffffffff167f9e31cca092b9e764bfc6b1b552d55ad4b035e609318fecc26cd38b34e8dd08bb60405160405180910390a45050565b6000600154905090565b3373ffffffffffffffffffffffffffffffffffffffff1660008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610aaa576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610aa190611d28565b60405180910390fd5b600360008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615610b6057610b0581611408565b8073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f013d6b862b532c38b01efed34c94d382085143963c63c76e87c24d4b7a37f98e60405160405180910390a35b50565b3373ffffffffffffffffffffffffffffffffffffffff1660008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610bf1576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610be890611d28565b60405180910390fd5b600060015490508160018190555081813373ffffffffffffffffffffffffffffffffffffffff167f480e8e496f7aff74972b0902e678fd5b564e4fb6527f0418da8a2c1aa628002260405160405180910390a45050565b3373ffffffffffffffffffffffffffffffffffffffff1660008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610cd6576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ccd90611d28565b60405180910390fd5b610ce06000611638565b565b6000600360008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff169050919050565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b60606002805480602002602001604051908101604052809291908181526020018280548015610de557602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610d9b575b5050505050905090565b3373ffffffffffffffffffffffffffffffffffffffff1660008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610e7d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e7490611d28565b60405180910390fd5b610e92816006546113b090919063ffffffff16565b600681905550808273ffffffffffffffffffffffffffffffffffffffff167f696de425f79f4a40bc6d2122ca50507f0efbeabbff86a84871b7196ab8ea8df760405160405180910390a35050565b6060600085858585604051602001610efb9493929190611c11565b60405160208183030381529060405280519060200120905060056000828152602001908152602001600020600001805480602002602001604051908101604052809291908181526020018280548015610fa957602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610f5f575b5050505050915050949350505050565b3373ffffffffffffffffffffffffffffffffffffffff1660008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614611047576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161103e90611d28565b60405180910390fd5b61105c816006546113c690919063ffffffff16565b60068190555050565b3373ffffffffffffffffffffffffffffffffffffffff1660008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146110f3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016110ea90611d28565b60405180910390fd5b600360008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff166112a357600280549050600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506001600360008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055506002819080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8064a302796c89446a96d63470b5b036212da26bd2debe5bec73e0170a9a5e8360405160405180910390a35b50565b3373ffffffffffffffffffffffffffffffffffffffff1660008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614611334576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161132b90611d28565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614156113a4576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161139b90611d08565b60405180910390fd5b6113ad81611638565b50565b600081836113be9190611f4f565b905092915050565b600081836113d49190611e6e565b905092915050565b600081836113ea9190611ef5565b905092915050565b600081836114009190611ec4565b905092915050565b6000600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050600060016002805490506114609190611f4f565b905080821461154f5760006002828154811061147f5761147e6121a3565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905080600284815481106114c1576114c06121a3565b5b9060005260206000200160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555082600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550505b6000600360008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055506000600460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555060028054806115fe576115fd612174565b5b6001900381819060005260206000200160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690559055505050565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b8280546117089061200d565b90600052602060002090601f01602090048101928261172a5760008555611771565b82601f1061174357805160ff1916838001178555611771565b82800160010185558215611771579182015b82811115611770578251825591602001919060010190611755565b5b50905061177e9190611782565b5090565b5b8082111561179b576000816000905550600101611783565b5090565b60006117b26117ad84611dc8565b611da3565b9050828152602081018484840111156117ce576117cd612206565b5b6117d9848285611fcb565b509392505050565b6000813590506117f0816122fd565b92915050565b600082601f83011261180b5761180a612201565b5b813561181b84826020860161179f565b91505092915050565b60008135905061183381612314565b92915050565b60006020828403121561184f5761184e612210565b5b600061185d848285016117e1565b91505092915050565b6000806040838503121561187d5761187c612210565b5b600061188b858286016117e1565b925050602061189c85828601611824565b9150509250929050565b600080600080608085870312156118c0576118bf612210565b5b60006118ce878288016117e1565b94505060206118df87828801611824565b935050604085013567ffffffffffffffff811115611900576118ff61220b565b5b61190c878288016117f6565b925050606085013567ffffffffffffffff81111561192d5761192c61220b565b5b611939878288016117f6565b91505092959194509250565b60006020828403121561195b5761195a612210565b5b600082013567ffffffffffffffff8111156119795761197861220b565b5b611985848285016117f6565b91505092915050565b6000602082840312156119a4576119a3612210565b5b60006119b284828501611824565b91505092915050565b60006119c783836119d3565b60208301905092915050565b6119dc81611f83565b82525050565b6119eb81611f83565b82525050565b611a026119fd82611f83565b6120b9565b82525050565b6000611a1382611e1e565b611a1d8185611e41565b9350611a2883611df9565b8060005b83811015611a59578151611a4088826119bb565b9750611a4b83611e34565b925050600181019050611a2c565b5085935050505092915050565b611a6f81611f95565b82525050565b6000611a8082611e29565b611a8a8185611e52565b9350611a9a818560208601611fda565b611aa381612215565b840191505092915050565b6000611ab982611e29565b611ac38185611e63565b9350611ad3818560208601611fda565b80840191505092915050565b60008154611aec8161200d565b611af68186611e52565b94506001821660008114611b115760018114611b2357611b56565b60ff1983168652602086019350611b56565b611b2c85611e09565b60005b83811015611b4e57815481890152600182019150602081019050611b2f565b808801955050505b50505092915050565b6000611b6c602683611e52565b9150611b7782612233565b604082019050919050565b6000611b8f601c83611e52565b9150611b9a82612282565b602082019050919050565b6000611bb2600683611e52565b9150611bbd826122ab565b602082019050919050565b6000611bd5601d83611e52565b9150611be0826122d4565b602082019050919050565b611bf481611fc1565b82525050565b611c0b611c0682611fc1565b6120dd565b82525050565b6000611c1d82876119f1565b601482019150611c2d8286611bfa565b602082019150611c3d8285611aae565b9150611c498284611aae565b915081905095945050505050565b6000602082019050611c6c60008301846119e2565b92915050565b60006020820190508181036000830152611c8c8184611a08565b905092915050565b6000602082019050611ca96000830184611a66565b92915050565b60006020820190508181036000830152611cc98184611a75565b905092915050565b60006040820190508181036000830152611ceb8185611adf565b90508181036020830152611cff8184611adf565b90509392505050565b60006020820190508181036000830152611d2181611b5f565b9050919050565b60006020820190508181036000830152611d4181611b82565b9050919050565b60006020820190508181036000830152611d6181611ba5565b9050919050565b60006020820190508181036000830152611d8181611bc8565b9050919050565b6000602082019050611d9d6000830184611beb565b92915050565b6000611dad611dbe565b9050611db9828261203f565b919050565b6000604051905090565b600067ffffffffffffffff821115611de357611de26121d2565b5b611dec82612215565b9050602081019050919050565b6000819050602082019050919050565b60008190508160005260206000209050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600081905092915050565b6000611e7982611fc1565b9150611e8483611fc1565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115611eb957611eb86120e7565b5b828201905092915050565b6000611ecf82611fc1565b9150611eda83611fc1565b925082611eea57611ee9612116565b5b828204905092915050565b6000611f0082611fc1565b9150611f0b83611fc1565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0483118215151615611f4457611f436120e7565b5b828202905092915050565b6000611f5a82611fc1565b9150611f6583611fc1565b925082821015611f7857611f776120e7565b5b828203905092915050565b6000611f8e82611fa1565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b82818337600083830152505050565b60005b83811015611ff8578082015181840152602081019050611fdd565b83811115612007576000848401525b50505050565b6000600282049050600182168061202557607f821691505b6020821081141561203957612038612145565b5b50919050565b61204882612215565b810181811067ffffffffffffffff82111715612067576120666121d2565b5b80604052505050565b600061207b82611fc1565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8214156120ae576120ad6120e7565b5b600182019050919050565b60006120c4826120cb565b9050919050565b60006120d682612226565b9050919050565b6000819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b60008160601b9050919050565b7f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160008201527f6464726573730000000000000000000000000000000000000000000000000000602082015250565b7f4f6e6c79206f776e65722063616e2063616c6c2066756e6374696f6e00000000600082015250565b7f466f726269640000000000000000000000000000000000000000000000000000600082015250565b7f4f6e6c79207369676e65722063616e2063616c6c2066756e6374696f6e000000600082015250565b61230681611f83565b811461231157600080fd5b50565b61231d81611fc1565b811461232857600080fd5b5056fea26469706673582212208879968f26c5ad21d7e3b58081ca73de324deb7256e1760798788f290bffec8364736f6c63430008060033",
			},
		},
	}
	// networks support portland upgrade
	_portlandUpgrade[mainNet] = _portlandUpgradeCfg
	_portlandUpgrade[devNet] = _portlandUpgradeCfg

	// detroit hardfork
	//nolint:lll
	_detroitUpgradeContent := &Upgrade{
		UpgradeName: "detroit",
		Configs: []*UpgradeConfig{
			{
				ContractAddr: systemcontracts.AddrValidatorSetContract,
				CommitURL:    "https://github.com/dogechain-lab/contracts/commit/3c43524af3a08084745fabd6d34cd1dad08e8587",
				Code:         "0x608060405234801561001057600080fd5b50600436106103d05760003560e01c80638aee8127116101ff578063c60453a81161011a578063e589b61e116100ad578063f90ecacc1161007c578063f90ecacc146108a5578063facd743b146108b8578063fd9275db146108cb578063fda259e0146108de57600080fd5b8063e589b61e14610854578063ede5d55814610867578063f2fde38b1461087a578063f7c618c11461088d57600080fd5b8063d0e30db0116100e9578063d0e30db014610805578063d431b1ac1461080d578063d946d27a14610815578063e1a2e8631461084157600080fd5b8063c60453a8146107da578063c96be4cb146107e2578063ca1e7819146107f5578063ced5bcc1146107fd57600080fd5b8063aea0e78b11610192578063be19973811610161578063be199738146107a4578063bebe9daf146107ac578063c0541aaa146107b4578063c2a45d4d146107c757600080fd5b8063aea0e78b14610761578063b46e552014610769578063b7ab4db51461077c578063bb872b4a1461079157600080fd5b80639dbf97db116101ce5780639dbf97db146106b5578063a2526bd3146106bd578063a310624f14610712578063ae2b3e831461074e57600080fd5b80638aee81271461065e5780638da5cb5b1461067157806395b5a5ee1461068257806396a602f31461069557600080fd5b806349df8d33116102ef5780636eab12bd11610282578063751bf20211610251578063751bf20214610627578063766718081461063a5780637bc897de146106425780638043c10c1461065557600080fd5b80636eab12bd146105cd5780636f856847146105f957806372d29f641461060157806373a3dda61461061457600080fd5b806359cdb14b116102be57806359cdb14b1461059d5780635b9db75a146105a55780635c975abb146105b85780636cbe6cd8146105c557600080fd5b806349df8d331461052a5780634d99dd16146105325780634f558e7914610545578063500a15641461057857600080fd5b806325646e1f116103675780633c21ec87116103365780633c21ec87146104d35780633cd1ecf5146104db57806340a141ff146105045780634878f4011461051757600080fd5b806325646e1f146104a857806332cc6f08146104bb578063346c90a8146104c3578063373d6132146104cb57600080fd5b8063179b4408116103a3578063179b44081461044f5780631e83409a1461046f5780631fe9768414610482578063201467741461049557600080fd5b8063026e402b146103d55780630397d458146103ea578063097475f7146103fd5780630ca95cf11461042e575b600080fd5b6103e86103e3366004613911565b6108f1565b005b6103e86103f8366004613875565b610bf9565b61041061040b366004613875565b610c75565b60405161042599989796959493929190613b03565b60405180910390f35b61044161043c366004613890565b610d55565b604051908152602001610425565b61044161045d366004613875565b601c6020526000908152604090205481565b6103e861047d366004613875565b610d82565b6103e8610490366004613875565b6110ba565b6103e86104a33660046139e7565b6111a6565b6103e86104b6366004613a00565b611209565b600b54610441565b600c54610441565b600854610441565b6103e8611274565b6104416104e9366004613875565b6001600160a01b03166000908152601c602052604090205490565b6103e8610512366004613875565b6113ba565b6103e86105253660046139e7565b611660565b600a54610441565b6103e8610540366004613911565b6116c3565b6105686105533660046139e7565b601d6020526000908152604090205460ff1681565b6040519015158152602001610425565b6009546001600160a01b03165b6040516001600160a01b039091168152602001610425565b601254610441565b6103e86105b33660046139e7565b611a47565b6013546105689060ff1681565b600f54610441565b6104416105db366004613875565b6001600160a01b03166000908152601a602052604090206003015490565b601154610441565b6103e861060f3660046138c3565b611aaa565b6103e8610622366004613875565b611b42565b6103e86106353660046139e7565b611caa565b610441611d0d565b610441610650366004613890565b611d29565b61044160145481565b6103e861066c366004613875565b611ef6565b6001546001600160a01b0316610585565b6103e8610690366004613875565b611f7a565b6104416106a3366004613875565b601e6020526000908152604090205481565b600d54610441565b6106f76106cb366004613890565b601b60209081526000928352604080842090915290825290208054600182015460029092015490919083565b60408051938452602084019290925290820152606001610425565b610741610720366004613875565b6001600160a01b03166000908152601a602052604090206007015460ff1690565b6040516104259190613ae2565b6103e861075c366004613990565b612278565b6104416124d6565b6103e8610777366004613875565b6124e5565b61078461259b565b6040516104259190613a95565b6103e861079f3660046139e7565b6125a7565b600e54610441565b61044161260a565b6104416107c2366004613875565b612616565b6103e86107d53660046139e7565b612637565b61044161269a565b6103e86107f0366004613875565b6126a6565b6107846127d3565b601054610441565b6103e8612d14565b6103e8612e6e565b610441610823366004613875565b6001600160a01b03166000908152601a602052604090206004015490565b6103e861084f3660046139e7565b612eac565b6103e8610862366004613875565b612f0f565b61078461087536600461393b565b612fdf565b6103e8610888366004613875565b6130cd565b6013546105859061010090046001600160a01b031681565b6105856108b33660046139e7565b613165565b6105686108c6366004613875565b61318f565b6103e86108d93660046139e7565b61319c565b6103e86108ec366004613875565b6131ff565b3233146109195760405162461bcd60e51b815260040161091090613bcb565b60405180910390fd5b6002600054141561093c5760405162461bcd60e51b815260040161091090613c6b565b600260005560135460ff16156109645760405162461bcd60e51b815260040161091090613ba1565b6012548110156109865760405162461bcd60e51b815260040161091090613c4a565b6009546040516323b872dd60e01b8152336004820152306024820152604481018390526001600160a01b03909116906323b872dd90606401602060405180830381600087803b1580156109d857600080fd5b505af11580156109ec573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a10919061396e565b506001600160a01b0382166000818152601b602090815260408083203384528252808320938352601a90915290206002600782015460ff166003811115610a5957610a59613d7e565b14610a765760405162461bcd60e51b815260040161091090613c02565b6000610ab08360010154610aaa64e8d4a51000610aa4866005015488600001546132cb90919063ffffffff16565b906132de565b906132ea565b90508015610b425760135460405163a9059cbb60e01b8152336004820152602481018390526101009091046001600160a01b03169063a9059cbb90604401602060405180830381600087803b158015610b0857600080fd5b505af1158015610b1c573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b40919061396e565b505b610b4a611d0d565b60028401558254610b5b90856132f6565b8084556005830154610b789164e8d4a5100091610aa491906132cb565b60018401556003820154610b8c90856132f6565b6003830155600854610b9e90856132f6565b600855610bac853386613302565b6040518481526001600160a01b0386169033907fe5541a6b6103d4fa7e021ed54fad39c66f27a76bd13d374cf6240ae6bd0bb72b906020015b60405180910390a350506001600055505050565b6001546001600160a01b03163314610c235760405162461bcd60e51b815260040161091090613b6a565b600980546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f3792de2485bcc1adb436c37819f81339378f5ec98f5b3534f7b71b70b5d31c0390600090a35050565b601a60205260009081526040902080548190610c9090613d12565b80601f0160208091040260200160405190810160405280929190818152602001828054610cbc90613d12565b8015610d095780601f10610cde57610100808354040283529160200191610d09565b820191906000526020600020905b815481529060010190602001808311610cec57829003601f168201915b5050505060018301546002840154600385015460048601546005870154600688015460079098015496976001600160a01b03909516969395509193909260ff8082169161010090041689565b6001600160a01b038083166000908152601b60209081526040808320938516835292905220545b92915050565b323314610da15760405162461bcd60e51b815260040161091090613bcb565b60026000541415610dc45760405162461bcd60e51b815260040161091090613c6b565b600260005560135460ff1615610dec5760405162461bcd60e51b815260040161091090613ba1565b6001600160a01b0381166000908152601b6020908152604080832033845290915290208054610e505760405162461bcd60e51b815260206004820152601060248201526f6e6f7468696e6720746f20636c61696d60801b6044820152606401610910565b6001600160a01b0382166000908152601a602052604080822081516101208101909252805482908290610e8290613d12565b80601f0160208091040260200160405190810160405280929190818152602001828054610eae90613d12565b8015610efb5780601f10610ed057610100808354040283529160200191610efb565b820191906000526020600020905b815481529060010190602001808311610ede57829003601f168201915b505050918352505060018201546001600160a01b0316602082015260028201546040820152600380830154606083015260048301546080830152600583015460a0830152600683015460c0830152600783015460e09092019160ff1690811115610f6757610f67613d7e565b6003811115610f7857610f78613d7e565b815260079190910154610100900460ff161515602090910152600183015460a08201518454929350600092610fbd9291610aaa9164e8d4a5100091610aa491906132cb565b9050801561106f5760a08201518354610fe09164e8d4a5100091610aa4916132cb565b600184015560135460405163a9059cbb60e01b8152336004820152602481018390526101009091046001600160a01b03169063a9059cbb90604401602060405180830381600087803b15801561103557600080fd5b505af1158015611049573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061106d919061396e565b505b6040518181526001600160a01b0385169033907ff7a40077ff7a04c7e61f6f26fb13774259ddf1b6bce9ecf26a8276cdd39926839060200160405180910390a3505060016000555050565b6001546001600160a01b031633146110e45760405162461bcd60e51b815260040161091090613b6a565b6001600160a01b0381166000908152601a602052604090206002600782015460ff16600381111561111757611117613d7e565b146111345760405162461bcd60e51b815260040161091090613c02565b6007810180546001919060ff191682805b021790555060078101546001600160a01b038316907f0c5c3450e67dce49a08116ce351f3a67c5b7d3217c607162d91189a7229174ea9060ff16600381111561119057611190613d7e565b6040519081526020015b60405180910390a25050565b6001546001600160a01b031633146111d05760405162461bcd60e51b815260040161091090613b6a565b600b805490829055604051829082907f3d657b82c31a672b7a8765b72f6f5e966cfb980ed039570a39ccdd70bf19c26690600090a35050565b6001546001600160a01b031633146112335760405162461bcd60e51b815260040161091090613b6a565b6010805463ffffffff83169182905560405190919082907f7414a33d82c698855ef5ed249e10e2f7481971f83f98cee8d7023f15ae0e881f90600090a35050565b6001546001600160a01b0316331461129e5760405162461bcd60e51b815260040161091090613b6a565b60005b6004548110156113ab576000600482815481106112c0576112c0613daa565b60009182526020808320909101546001600160a01b0316808352601a9091526040822090925090600782015460ff16600381111561130057611300613d7e565b1415611396576001810180546001600160a01b0384166001600160a01b031990911617905560078101805460ff1916600217905561133d82613358565b5060078101546001600160a01b038316907f0c5c3450e67dce49a08116ce351f3a67c5b7d3217c607162d91189a7229174ea9060ff16600381111561138457611384613d7e565b60405190815260200160405180910390a25b505080806113a390613d4d565b9150506112a1565b506113b8600460006136db565b565b6001546001600160a01b031633146113e45760405162461bcd60e51b815260040161091090613b6a565b6001600160a01b0381166000908152601a60205260408082208151610120810190925280548290829061141690613d12565b80601f016020809104026020016040519081016040528092919081815260200182805461144290613d12565b801561148f5780601f106114645761010080835404028352916020019161148f565b820191906000526020600020905b81548152906001019060200180831161147257829003601f168201915b505050918352505060018201546001600160a01b0316602082015260028201546040820152600380830154606083015260048301546080830152600583015460a0830152600683015460c0830152600783015460e09092019160ff16908111156114fb576114fb613d7e565b600381111561150c5761150c613d7e565b815260079190910154610100900460ff161515602090910152905060008160e00151600381111561153f5761153f613d7e565b14156115795760405162461bcd60e51b81526020600482015260096024820152681b9bdd08199bdd5b9960ba1b6044820152606401610910565b6060810151156115b85760405162461bcd60e51b815260206004820152600a6024820152691a185cc81cdd185ad95960b21b6044820152606401610910565b6115c182613365565b506001600160a01b0382166000908152601a60205260408120906115e582826136f9565b506001810180546001600160a01b0319169055600060028201819055600382018190556004820181905560058201819055600682018190556007909101805461ffff191690556040516001600160a01b038416917fe1434e25d6611e0db941968fdc97811c982ac1602e951637d206f5fdda9dd8f191a25050565b6001546001600160a01b0316331461168a5760405162461bcd60e51b815260040161091090613b6a565b600e805490829055604051829082907fb64c2fee5d0035d3aa1122935a0d2800f151a0853dd89adbabb795a6190f8be090600090a35050565b3233146116e25760405162461bcd60e51b815260040161091090613bcb565b600260005414156117055760405162461bcd60e51b815260040161091090613c6b565b600260005560135460ff161561172d5760405162461bcd60e51b815260040161091090613ba1565b6001600160a01b0382166000908152601b602090815260408083203384529091529020805482118015906117615750600082115b6117a25760405162461bcd60e51b81526020600482015260126024820152716e6f7468696e6720746f20756e7374616b6560701b6044820152606401610910565b6117aa611d0d565b6117c182600201546117bb60105490565b906132f6565b106118005760405162461bcd60e51b815260206004820152600f60248201526e65706f6368206e6f7420616c6c6f7760881b6044820152606401610910565b6001600160a01b038084166000908152601a6020526040902060018101549091163314156118625760405162461bcd60e51b815260206004820152600f60248201526e6f776e6572206e6f7420616c6c6f7760881b6044820152606401610910565b60006118908360010154610aaa64e8d4a51000610aa4866005015488600001546132cb90919063ffffffff16565b905080156119225760135460405163a9059cbb60e01b8152336004820152602481018390526101009091046001600160a01b03169063a9059cbb90604401602060405180830381600087803b1580156118e857600080fd5b505af11580156118fc573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611920919061396e565b505b825461192e90856132ea565b808455600583015461194b9164e8d4a5100091610aa491906132cb565b6001840155600382015461195f90856132ea565b600383015560085461197190856132ea565b60085561197f853386613372565b60095460405163a9059cbb60e01b8152336004820152602481018690526001600160a01b039091169063a9059cbb90604401602060405180830381600087803b1580156119cb57600080fd5b505af11580156119df573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611a03919061396e565b5060408051858152602081018390526001600160a01b0387169133917f3aace7340547de7b9156593a7652dc07ee900cea3fd8f82cb6c9d38b408298029101610be5565b6001546001600160a01b03163314611a715760405162461bcd60e51b815260040161091090613b6a565b6012805490829055604051829082907fc18cde4032061961886377a68e664be72416785473fa678fa416ed2a31c1b10f90600090a35050565b6001600160a01b038281166000908152601a6020526040902060018101549091163314611ae95760405162461bcd60e51b815260040161091090613c26565b8151611afb9082906020850190613733565b50826001600160a01b03167f8a0ff04a1f70e76c640c0520aa1550c775b38ce28af05fdaee467ad160d05fb183604051611b359190613af0565b60405180910390a2505050565b323314611b615760405162461bcd60e51b815260040161091090613bcb565b60135460ff1615611b845760405162461bcd60e51b815260040161091090613ba1565b6000611b8e611d0d565b6001600160a01b0383166000908152601a602052604090209091506003600782015460ff166003811115611bc457611bc4613d7e565b14611be15760405162461bcd60e51b815260040161091090613c02565b60018101546001600160a01b03163314611c0d5760405162461bcd60e51b815260040161091090613c26565b80600201548211611c505760405162461bcd60e51b815260206004820152600d60248201526c1cdd1a5b1b081a5b881a985a5b609a1b6044820152606401610910565b60078101805460ff19166002908117909155600060068301819055908201556040518281526001600160a01b038416907f198b4f09d57ab5dbbf891a135940a04087b2544bebf3506cc81e1b64063b6d6590602001611b35565b6001546001600160a01b03163314611cd45760405162461bcd60e51b815260040161091090613b6a565b600f805490829055604051829082907fdf736d7e2a17c66d20e9bd8c8b51ee5d59a97733dde732893d13fee45469f99b90600090a35050565b6000611d24600c54436132de90919063ffffffff16565b905090565b6001600160a01b038083166000908152601b6020908152604080832093851683529281528282208351606081018552815480825260018301549382019390935260029091015493810193909352909190611d87576000915050610d7c565b6001600160a01b0384166000908152601a602052604080822081516101208101909252805482908290611db990613d12565b80601f0160208091040260200160405190810160405280929190818152602001828054611de590613d12565b8015611e325780601f10611e0757610100808354040283529160200191611e32565b820191906000526020600020905b815481529060010190602001808311611e1557829003601f168201915b505050918352505060018201546001600160a01b0316602082015260028201546040820152600380830154606083015260048301546080830152600583015460a0830152600683015460c0830152600783015460e09092019160ff1690811115611e9e57611e9e613d7e565b6003811115611eaf57611eaf613d7e565b815260079190910154610100900460ff16151560209182015283015160a08201518451929350611eed92610aaa9164e8d4a5100091610aa4916132cb565b95945050505050565b6001546001600160a01b03163314611f205760405162461bcd60e51b815260040161091090613b6a565b601380546001600160a01b03838116610100818102610100600160a81b031985161790945560405193909204169182907fab27a2419bd7a3bc605bff66b38aacb84061d9e20edab7f7680ce52e6fcd925690600090a35050565b323314611f995760405162461bcd60e51b815260040161091090613bcb565b60026000541415611fbc5760405162461bcd60e51b815260040161091090613c6b565b600260005560135460ff1615611fe45760405162461bcd60e51b815260040161091090613ba1565b6001600160a01b038181166000908152601a60205260409020600181015490911633146120235760405162461bcd60e51b815260040161091090613c26565b6001600160a01b0382166000908152601b60209081526040808320338452909152902080546120895760405162461bcd60e51b81526020600482015260126024820152716e6f7468696e6720746f20756e7374616b6560701b6044820152606401610910565b8054600182015460058401546000916120b291610aaa9064e8d4a5100090610aa49087906132cb565b905080156121445760135460405163a9059cbb60e01b8152336004820152602481018390526101009091046001600160a01b03169063a9059cbb90604401602060405180830381600087803b15801561210a57600080fd5b505af115801561211e573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612142919061396e565b505b6001600160a01b0385166000908152601b6020908152604080832033845290915281208181556001810182905560020155600384015461218490836132ea565b600385015560078401805460ff191660011790556008546121a590836132ea565b6008556121b3853384613372565b60095460405163a9059cbb60e01b8152336004820152602481018490526001600160a01b039091169063a9059cbb90604401602060405180830381600087803b1580156121ff57600080fd5b505af1158015612213573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612237919061396e565b506040516001600160a01b038616907fe1434e25d6611e0db941968fdc97811c982ac1602e951637d206f5fdda9dd8f190600090a250506001600055505050565b3233146122975760405162461bcd60e51b815260040161091090613bcb565b600260005414156122ba5760405162461bcd60e51b815260040161091090613c6b565b600260005560135460ff16156122e25760405162461bcd60e51b815260040161091090613ba1565b6011548110156123045760405162461bcd60e51b815260040161091090613c4a565b6009546040516323b872dd60e01b8152336004820152306024820152604481018390526001600160a01b03909116906323b872dd90606401602060405180830381600087803b15801561235657600080fd5b505af115801561236a573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061238e919061396e565b506001600160a01b0382166000908152601a6020526040812090600782015460ff1660038111156123c1576123c1613d7e565b146123fe5760405162461bcd60e51b815260206004820152600d60248201526c185b1c9958591e48195e1a5cdd609a1b6044820152606401610910565b6001600160a01b0383166000908152601b60209081526040808320338452825290912085519091612433918491880190613733565b50600180830180546001600160a01b0319163317905560078301805460ff19168280021790555060038201839055612469611d0d565b600282015582815560085461247e90846132f6565b60085561248a84613358565b50612496843385613302565b6040516001600160a01b038516907fe366c1c0452ed8eec96861e9e54141ebff23c9ec89fe27b996b45f5ec388498790600090a250506001600055505050565b6000611d2460016117bb611d0d565b6001546001600160a01b0316331461250f5760405162461bcd60e51b815260040161091090613b6a565b6001600160a01b0381166000908152601a602052604090206011548160030154101561254d5760405162461bcd60e51b815260040161091090613c4a565b6001600782015460ff16600381111561256857612568613d7e565b146125855760405162461bcd60e51b815260040161091090613c02565b6007810180546002919060ff1916600183611145565b6060611d2460156133f8565b6001546001600160a01b031633146125d15760405162461bcd60e51b815260040161091090613b6a565b600a805490829055604051829082907f79a5349732f93288abbb68e251c3dfc325bf3ee6fde7786d919155d39733e0f590600090a35050565b6000611d246015613405565b6001600160a01b0381166000908152601960205260408120610d7c90613405565b6001546001600160a01b031633146126615760405162461bcd60e51b815260040161091090613b6a565b600d805490829055604051829082907fad65adbcfea0d9e94f88fee2e0422a61d519dc522506374972587aefe7194bd490600090a35050565b6000611d246017613405565b4133146126f55760405162461bcd60e51b815260206004820152601f60248201527f4f6e6c7920636f696e626173652063616e2063616c6c2066756e6374696f6e006044820152606401610910565b336000908152601e60205260409020546127109060016132f6565b336000908152601e60209081526040808320939093556001600160a01b0384168252601a9052206002600782015460ff16600381111561275257612752613d7e565b14156127cf576000612762611d0d565b9050600061277e600184600601546132f690919063ffffffff16565b6006840181905560408051828152602081018590529192506001600160a01b038616917f83b04ecf7330997e742429a641e136d9f3698c3e9ac9cb9ce0cc2d6da36a244d910160405180910390a250505b5050565b6004546060901561283e57600480548060200260200160405190810160405280929190818152602001828054801561283457602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311612816575b5050505050905090565b600061284861260a565b905060008167ffffffffffffffff81111561286557612865613dc0565b60405190808252806020026020018201604052801561288e578160200160208202803683370190505b5090506000805b838110156129305760006128aa60158361340f565b905060026001600160a01b0382166000908152601a602052604090206007015460ff1660038111156128de576128de613d7e565b141561291d57808484815181106128f7576128f7613daa565b6001600160a01b03909216602092830291909101909101528261291981613d4d565b9350505b508061292881613d4d565b915050612895565b50600061293c600b5490565b90508181111561294d575080612d0b565b60005b81811015612d095760008190506000601a600087848151811061297557612975613daa565b60200260200101516001600160a01b03166001600160a01b03168152602001908152602001600020604051806101200160405290816000820180546129b990613d12565b80601f01602080910402602001604051908101604052809291908181526020018280546129e590613d12565b8015612a325780601f10612a0757610100808354040283529160200191612a32565b820191906000526020600020905b815481529060010190602001808311612a1557829003601f168201915b505050918352505060018201546001600160a01b0316602082015260028201546040820152600380830154606083015260048301546080830152600583015460a0830152600683015460c0830152600783015460e09092019160ff1690811115612a9e57612a9e613d7e565b6003811115612aaf57612aaf613d7e565b815260079190910154610100900460ff16151560209091015290506000612ad7846001613ca2565b90505b85811015612c7a576000601a6000898481518110612afa57612afa613daa565b60200260200101516001600160a01b03166001600160a01b0316815260200190815260200160002060405180610120016040529081600082018054612b3e90613d12565b80601f0160208091040260200160405190810160405280929190818152602001828054612b6a90613d12565b8015612bb75780601f10612b8c57610100808354040283529160200191612bb7565b820191906000526020600020905b815481529060010190602001808311612b9a57829003601f168201915b505050918352505060018201546001600160a01b0316602082015260028201546040820152600380830154606083015260048301546080830152600583015460a0830152600683015460c0830152600783015460e09092019160ff1690811115612c2357612c23613d7e565b6003811115612c3457612c34613d7e565b815260079190910154610100900460ff161515602090910152606081810151908501519192501115612c67578193508092505b5080612c7281613d4d565b915050612ada565b50858281518110612c8d57612c8d613daa565b6020026020010151868481518110612ca757612ca7613daa565b6020026020010151878581518110612cc157612cc1613daa565b60200260200101888581518110612cda57612cda613daa565b6001600160a01b0393841660209182029290920101529116905250819050612d0181613d4d565b915050612950565b505b82525092915050565b413314612d635760405162461bcd60e51b815260206004820152601f60248201527f4f6e6c7920636f696e626173652063616e2063616c6c2066756e6374696f6e006044820152606401610910565b336000908152601a602052604090206002600782015460ff166003811115612d8d57612d8d613d7e565b148015612d9e575060008160030154115b8015612dba5750436000908152601d602052604090205460ff16155b15612e6b57436000908152601d60205260409020805460ff19166001179055600a54601454612de8916132f6565b6014556003810154600a54600091612e0991610aa49064e8d4a510006132cb565b6005830154909150612e1b90826132f6565b6005830155600a546004830154612e31916132f6565b6004830155600a5460405190815233907f62bf3b2d86d93be4bb7aa06117c0e1719716f019f3265fdef4df36510ae5070a9060200161119a565b50565b6001546001600160a01b03163314612e985760405162461bcd60e51b815260040161091090613b6a565b6013805460ff19811660ff90911615179055565b6001546001600160a01b03163314612ed65760405162461bcd60e51b815260040161091090613b6a565b6011805490829055604051829082907f207082661d623a88e041ad2d52c2d4ddc719880c70c3ab44aa81accff9bd86ed90600090a35050565b6001546001600160a01b03163314612f395760405162461bcd60e51b815260040161091090613b6a565b6001600160a01b0381166000908152601a60205260409020600e5481600601541015612f775760405162461bcd60e51b815260040161091090613c4a565b6000612f81611d0d565b9050612f90816117bb600f5490565b600283015560078201805460ff191660031790556040518181526001600160a01b038416907feb7d7a49847ec491969db21a0e31b234565a9923145a2d1b56a75c9e9582580290602001611b35565b606060008267ffffffffffffffff811115612ffc57612ffc613dc0565b604051908082528060200260200182016040528015613025578160200160208202803683370190505b509050600061303386612616565b905060005b848110156130c2576000613050826117bb89896132cb565b9050828110156130af576001600160a01b038816600090815260196020526040902061307c908261340f565b84838151811061308e5761308e613daa565b60200260200101906001600160a01b031690816001600160a01b0316815250505b50806130ba81613d4d565b915050613038565b509095945050505050565b6001546001600160a01b031633146130f75760405162461bcd60e51b815260040161091090613b6a565b6001600160a01b03811661315c5760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b6064820152608401610910565b612e6b8161341b565b6004818154811061317557600080fd5b6000918252602090912001546001600160a01b0316905081565b6000610d7c60158361346d565b6001546001600160a01b031633146131c65760405162461bcd60e51b815260040161091090613b6a565b600c805490829055604051829082907f62d532a388a6e5e7ad8089a8aff169a6045b666b20a5a11070805ffc8ed16ee190600090a35050565b6001546001600160a01b031633146132295760405162461bcd60e51b815260040161091090613b6a565b6001600160a01b0381166000908152601a602052604090206003600782015460ff16600381111561325c5761325c613d7e565b146132795760405162461bcd60e51b815260040161091090613c02565b60078101805460ff19166002908117909155600060068301819055908201556001600160a01b0382167f198b4f09d57ab5dbbf891a135940a04087b2544bebf3506cc81e1b64063b6d65611190611d0d565b60006132d78284613cdc565b9392505050565b60006132d78284613cba565b60006132d78284613cfb565b60006132d78284613ca2565b6001600160a01b0382166000908152601c602052604090205461332590826132f6565b6001600160a01b0383166000908152601c60205260409020556133478261348f565b50613352838361349c565b50505050565b6000610d7c6015836134ba565b6000610d7c6015836134cf565b6001600160a01b0382166000908152601c602052604090205461339590826132ea565b6001600160a01b0383166000908152601c602052604090208190556133bf576133bd826134e4565b505b6001600160a01b038084166000908152601b60209081526040808320938616835292905220546133f35761335283836134f1565b505050565b606060006132d783613513565b6000610d7c825490565b60006132d7838361356f565b600180546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b6001600160a01b038116600090815260018301602052604081205415156132d7565b6000610d7c6017836134ba565b6001600160a01b03821660009081526019602052604081206132d790835b60006132d7836001600160a01b038416613599565b60006132d7836001600160a01b0384166135e8565b6000610d7c6017836134cf565b6001600160a01b03821660009081526019602052604081206132d790836134cf565b60608160000180548060200260200160405190810160405280929190818152602001828054801561356357602002820191906000526020600020905b81548152602001906001019080831161354f575b50505050509050919050565b600082600001828154811061358657613586613daa565b9060005260206000200154905092915050565b60008181526001830160205260408120546135e057508154600181810184556000848152602080822090930184905584548482528286019093526040902091909155610d7c565b506000610d7c565b600081815260018301602052604081205480156136d157600061360c600183613cfb565b855490915060009061362090600190613cfb565b905081811461368557600086600001828154811061364057613640613daa565b906000526020600020015490508087600001848154811061366357613663613daa565b6000918252602080832090910192909255918252600188019052604090208390555b855486908061369657613696613d94565b600190038181906000526020600020016000905590558560010160008681526020019081526020016000206000905560019350505050610d7c565b6000915050610d7c565b5080546000825590600052602060002090810190612e6b91906137b7565b50805461370590613d12565b6000825580601f10613715575050565b601f016020900490600052602060002090810190612e6b91906137b7565b82805461373f90613d12565b90600052602060002090601f01602090048101928261376157600085556137a7565b82601f1061377a57805160ff19168380011785556137a7565b828001600101855582156137a7579182015b828111156137a757825182559160200191906001019061378c565b506137b39291506137b7565b5090565b5b808211156137b357600081556001016137b8565b80356001600160a01b03811681146137e357600080fd5b919050565b600082601f8301126137f957600080fd5b813567ffffffffffffffff8082111561381457613814613dc0565b604051601f8301601f19908116603f0116810190828211818310171561383c5761383c613dc0565b8160405283815286602085880101111561385557600080fd5b836020870160208301376000602085830101528094505050505092915050565b60006020828403121561388757600080fd5b6132d7826137cc565b600080604083850312156138a357600080fd5b6138ac836137cc565b91506138ba602084016137cc565b90509250929050565b600080604083850312156138d657600080fd5b6138df836137cc565b9150602083013567ffffffffffffffff8111156138fb57600080fd5b613907858286016137e8565b9150509250929050565b6000806040838503121561392457600080fd5b61392d836137cc565b946020939093013593505050565b60008060006060848603121561395057600080fd5b613959846137cc565b95602085013595506040909401359392505050565b60006020828403121561398057600080fd5b815180151581146132d757600080fd5b6000806000606084860312156139a557600080fd5b833567ffffffffffffffff8111156139bc57600080fd5b6139c8868287016137e8565b9350506139d7602085016137cc565b9150604084013590509250925092565b6000602082840312156139f957600080fd5b5035919050565b600060208284031215613a1257600080fd5b813563ffffffff811681146132d757600080fd5b60048110613a4457634e487b7160e01b600052602160045260246000fd5b9052565b6000815180845260005b81811015613a6e57602081850181015186830182015201613a52565b81811115613a80576000602083870101525b50601f01601f19169290920160200192915050565b6020808252825182820181905260009190848201906040850190845b81811015613ad65783516001600160a01b031683529284019291840191600101613ab1565b50909695505050505050565b60208101610d7c8284613a26565b6020815260006132d76020830184613a48565b6000610120808352613b178184018d613a48565b91505060018060a01b038a1660208301528860408301528760608301528660808301528560a08301528460c0830152613b5360e0830185613a26565b8215156101008301529a9950505050505050505050565b6020808252601c908201527f4f6e6c79206f776e65722063616e2063616c6c2066756e6374696f6e00000000604082015260600190565b60208082526010908201526f14185d5cd8589b194e881c185d5cd95960821b604082015260600190565b6020808252601a908201527f4f6e6c7920454f412063616e2063616c6c2066756e6374696f6e000000000000604082015260600190565b6020808252600a90820152696261642073746174757360b01b604082015260600190565b6020808252600a908201526937b7363c9037bbb732b960b11b604082015260600190565b602080825260079082015266746f6f206c6f7760c81b604082015260600190565b6020808252601f908201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c00604082015260600190565b60008219821115613cb557613cb5613d68565b500190565b600082613cd757634e487b7160e01b600052601260045260246000fd5b500490565b6000816000190483118215151615613cf657613cf6613d68565b500290565b600082821015613d0d57613d0d613d68565b500390565b600181811c90821680613d2657607f821691505b60208210811415613d4757634e487b7160e01b600052602260045260246000fd5b50919050565b6000600019821415613d6157613d61613d68565b5060010190565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052602160045260246000fd5b634e487b7160e01b600052603160045260246000fd5b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052604160045260246000fdfea264697066735822122032be16e9fd2cecd1106fc4daf25d6d3de34e4f65deaa5cae333d84bc77b9ecb064736f6c63430008060033",
				DefaultInitStorage: map[types.Hash]types.Hash{
					types.StringToHash("0x000000000000000000000000000000000000000a"): types.StringToHash("0xde0b6b3a7640000"),     // rewardPerBlock
					types.StringToHash("0x000000000000000000000000000000000000000b"): types.StringToHash("0x19"),                  // activeValidatorsLength
					types.StringToHash("0x000000000000000000000000000000000000000c"): types.StringToHash("0x1c20"),                // epochBlockInterval
					types.StringToHash("0x000000000000000000000000000000000000000d"): types.StringToHash("0x12c"),                 // misdemeanorThreshold
					types.StringToHash("0x000000000000000000000000000000000000000e"): types.StringToHash("0x384"),                 // felonyThreshold
					types.StringToHash("0x000000000000000000000000000000000000000f"): types.StringToHash("0xc"),                   // validatorJailEpochLength
					types.StringToHash("0x0000000000000000000000000000000000000010"): types.StringToHash("0x6"),                   // minStakePeriod
					types.StringToHash("0x0000000000000000000000000000000000000011"): types.StringToHash("0x21e19e0c9bab2400000"), // minValidatorStakeAmount
					types.StringToHash("0x0000000000000000000000000000000000000012"): types.StringToHash("0x56bc75e2d63100000"),   // minDelegatorStakeAmount
				},
			},
			{
				ContractAddr: systemcontracts.AddrBridgeContract,
				CommitURL:    "https://github.com/dogechain-lab/contracts/commit/3c43524af3a08084745fabd6d34cd1dad08e8587",
				Code:         "0x60806040526004361061012a5760003560e01c806367058d29116100ab5780639dc29fac1161006f5780639dc29fac14610314578063cd86a6cb14610334578063d431b1ac14610354578063de242ff414610369578063eb12d61e1461037f578063f2fde38b1461039f57600080fd5b806367058d291461025c578063715018a61461027c5780637df73e27146102915780638da5cb5b146102ca57806394cf795e146102f257600080fd5b806331fb67c2116100f257806331fb67c2146101ca57806334fcf437146101dd5780634cde3a53146101fd57806354c4633e146102125780635c975abb1461023257600080fd5b806310bad4cf1461012f57806311e330b21461015157806318160ddd1461017157806319e5c034146101955780632c4e722e146101b5575b600080fd5b34801561013b57600080fd5b5061014f61014a36600461109c565b6103bf565b005b34801561015d57600080fd5b5061014f61016c36600461109c565b610405565b34801561017d57600080fd5b506006545b6040519081526020015b60405180910390f35b3480156101a157600080fd5b5061014f6101b0366004610fe1565b61043c565b3480156101c157600080fd5b50600754610182565b61014f6101d836600461105f565b6106f2565b3480156101e957600080fd5b5061014f6101f836600461109c565b6107d7565b34801561020957600080fd5b50600154610182565b34801561021e57600080fd5b5061014f61022d366004610f9c565b61083c565b34801561023e57600080fd5b5060085461024c9060ff1681565b604051901515815260200161018c565b34801561026857600080fd5b5061014f61027736600461109c565b6108ca565b34801561028857600080fd5b5061014f61092f565b34801561029d57600080fd5b5061024c6102ac366004610f9c565b6001600160a01b031660009081526003602052604090205460ff1690565b3480156102d657600080fd5b506000546040516001600160a01b03909116815260200161018c565b3480156102fe57600080fd5b50610307610965565b60405161018c91906111aa565b34801561032057600080fd5b5061014f61032f366004610fb7565b6109c7565b34801561034057600080fd5b5061030761034f366004610fe1565b610a5e565b34801561036057600080fd5b5061014f610afa565b34801561037557600080fd5b5061018260095481565b34801561038b57600080fd5b5061014f61039a366004610f9c565b610b38565b3480156103ab57600080fd5b5061014f6103ba366004610f9c565b610c25565b6000546001600160a01b031633146103f25760405162461bcd60e51b81526004016103e990611258565b60405180910390fd5b6009546103ff9082610cbd565b60095550565b6000546001600160a01b0316331461042f5760405162461bcd60e51b81526004016103e990611258565b6009546103ff9082610cd0565b3360009081526003602052604090205460ff1661049b5760405162461bcd60e51b815260206004820152601d60248201527f4f6e6c79207369676e65722063616e2063616c6c2066756e6374696f6e00000060448201526064016103e9565b60085460ff16156104be5760405162461bcd60e51b81526004016103e99061128f565b8260095410156105095760405162461bcd60e51b8152602060048201526016602482015275696e73756666696369656e7420616c6c6f77616e636560501b60448201526064016103e9565b6000848484846040516020016105229493929190611155565b60408051808303601f190181529181528151602092830120600081815260059093529120600481015491925090600160a01b900460ff16156105655750506106ec565b60005b81548110156105bc5781543390839083908110610587576105876113d7565b6000918252602090912001546001600160a01b031614156105aa575050506106ec565b806105b481611390565b915050610568565b506004810180546001600160a01b0319166001600160a01b0388161790556001810185905582516105f69060038301906020860190610e5a565b50835161060c9060028301906020870190610e5a565b5080546001810182556000828152602090200180546001600160a01b031916331790556002805461063d91906112d1565b815411801561065857506004810154600160a01b900460ff16155b156106e95760048101805460ff60a01b1916600160a01b17905560065461067f9086610cd0565b60065560095461068f9086610cbd565b600955600181015460048201546040516001600160a01b03909116907fbceab28ca952a9177ce3716580d6c8c2d677fdf721b944e57a5e7322622ffdc9906106e0906002860190600387019061122a565b60405180910390a35b50505b50505050565b60085460ff16156107155760405162461bcd60e51b81526004016103e99061128f565b6001543410156107505760405162461bcd60e51b8152602060048201526006602482015265119bdc989a5960d21b60448201526064016103e9565b600061077361271061076d60075434610cdc90919063ffffffff16565b90610ce8565b905060006107813483610cbd565b6006549091506107919082610cbd565b6006556040518290829033907f62116a798bb58cc967874bea4d771de2f9aeec6c64189ff2e5a551072f3106f9906107ca9088906111f7565b60405180910390a4505050565b6000546001600160a01b031633146108015760405162461bcd60e51b81526004016103e990611258565b60078054908290556040518290829033907f9e31cca092b9e764bfc6b1b552d55ad4b035e609318fecc26cd38b34e8dd08bb90600090a45050565b6000546001600160a01b031633146108665760405162461bcd60e51b81526004016103e990611258565b6001600160a01b03811660009081526003602052604090205460ff16156108c75761089081610cf4565b6040516001600160a01b0382169033907f013d6b862b532c38b01efed34c94d382085143963c63c76e87c24d4b7a37f98e90600090a35b50565b6000546001600160a01b031633146108f45760405162461bcd60e51b81526004016103e990611258565b60018054908290556040518290829033907f480e8e496f7aff74972b0902e678fd5b564e4fb6527f0418da8a2c1aa628002290600090a45050565b6000546001600160a01b031633146109595760405162461bcd60e51b81526004016103e990611258565b6109636000610e0a565b565b606060028054806020026020016040519081016040528092919081815260200182805480156109bd57602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831161099f575b5050505050905090565b6000546001600160a01b031633146109f15760405162461bcd60e51b81526004016103e990611258565b60085460ff1615610a145760405162461bcd60e51b81526004016103e99061128f565b600654610a219082610cbd565b60065560405181906001600160a01b038416907f696de425f79f4a40bc6d2122ca50507f0efbeabbff86a84871b7196ab8ea8df790600090a35050565b6060600085858585604051602001610a799493929190611155565b60408051601f1981840301815282825280516020918201206000818152600583528390208054808402860184019094528385529094509190830182828015610aea57602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311610acc575b5050505050915050949350505050565b6000546001600160a01b03163314610b245760405162461bcd60e51b81526004016103e990611258565b6008805460ff19811660ff90911615179055565b6000546001600160a01b03163314610b625760405162461bcd60e51b81526004016103e990611258565b6001600160a01b03811660009081526003602052604090205460ff166108c757600280546001600160a01b03831660008181526004602090815260408083209490945560039052828120805460ff19166001908117909155845490810185559381527f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace90930180546001600160a01b031916821790559051909133917f8064a302796c89446a96d63470b5b036212da26bd2debe5bec73e0170a9a5e839190a350565b6000546001600160a01b03163314610c4f5760405162461bcd60e51b81526004016103e990611258565b6001600160a01b038116610cb45760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b60648201526084016103e9565b6108c781610e0a565b6000610cc98284611312565b9392505050565b6000610cc982846112b9565b6000610cc982846112f3565b6000610cc982846112d1565b6001600160a01b038116600090815260046020526040812054600254909190610d1f90600190611312565b9050808214610da757600060028281548110610d3d57610d3d6113d7565b600091825260209091200154600280546001600160a01b039092169250829185908110610d6c57610d6c6113d7565b600091825260208083209190910180546001600160a01b0319166001600160a01b039485161790559290911681526004909152604090208290555b6001600160a01b0383166000908152600360209081526040808320805460ff1916905560049091528120556002805480610de357610de36113c1565b600082815260209020810160001990810180546001600160a01b0319169055019055505050565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b828054610e6690611355565b90600052602060002090601f016020900481019282610e885760008555610ece565b82601f10610ea157805160ff1916838001178555610ece565b82800160010185558215610ece579182015b82811115610ece578251825591602001919060010190610eb3565b50610eda929150610ede565b5090565b5b80821115610eda5760008155600101610edf565b80356001600160a01b0381168114610f0a57600080fd5b919050565b600082601f830112610f2057600080fd5b813567ffffffffffffffff80821115610f3b57610f3b6113ed565b604051601f8301601f19908116603f01168101908282118183101715610f6357610f636113ed565b81604052838152866020858801011115610f7c57600080fd5b836020870160208301376000602085830101528094505050505092915050565b600060208284031215610fae57600080fd5b610cc982610ef3565b60008060408385031215610fca57600080fd5b610fd383610ef3565b946020939093013593505050565b60008060008060808587031215610ff757600080fd5b61100085610ef3565b935060208501359250604085013567ffffffffffffffff8082111561102457600080fd5b61103088838901610f0f565b9350606087013591508082111561104657600080fd5b5061105387828801610f0f565b91505092959194509250565b60006020828403121561107157600080fd5b813567ffffffffffffffff81111561108857600080fd5b61109484828501610f0f565b949350505050565b6000602082840312156110ae57600080fd5b5035919050565b8054600090600181811c90808316806110cf57607f831692505b60208084108214156110f157634e487b7160e01b600052602260045260246000fd5b8388526020880182801561110c576001811461111d57611148565b60ff19871682528282019750611148565b60008981526020902060005b8781101561114257815484820152908601908401611129565b83019850505b5050505050505092915050565b6bffffffffffffffffffffffff198560601b16815283601482015260008351611185816034850160208801611329565b83519083019061119c816034840160208801611329565b016034019695505050505050565b6020808252825182820181905260009190848201906040850190845b818110156111eb5783516001600160a01b0316835292840192918401916001016111c6565b50909695505050505050565b6020815260008251806020840152611216816040850160208701611329565b601f01601f19169190910160400192915050565b60408152600061123d60408301856110b5565b828103602084015261124f81856110b5565b95945050505050565b6020808252601c908201527f4f6e6c79206f776e65722063616e2063616c6c2066756e6374696f6e00000000604082015260600190565b60208082526010908201526f14185d5cd8589b194e881c185d5cd95960821b604082015260600190565b600082198211156112cc576112cc6113ab565b500190565b6000826112ee57634e487b7160e01b600052601260045260246000fd5b500490565b600081600019048311821515161561130d5761130d6113ab565b500290565b600082821015611324576113246113ab565b500390565b60005b8381101561134457818101518382015260200161132c565b838111156106ec5750506000910152565b600181811c9082168061136957607f821691505b6020821081141561138a57634e487b7160e01b600052602260045260246000fd5b50919050565b60006000198214156113a4576113a46113ab565b5060010190565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052603160045260246000fd5b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052604160045260246000fdfea26469706673582212204dd9324e3ea0774ff580135051d4de3fbff06834c900bed357126556fbca493864736f6c63430008060033",
			},
		},
	}
	// network supports detroit upgrade
	_detroitUpgrade[mainNet] = _detroitUpgradeContent
	_detroitUpgrade[devNet] = _detroitUpgradeContent
}

func UpgradeSystem(
	chainID int,
	forks *chain.Forks,
	blockNumber uint64,
	txn *state.Txn,
	logger hclog.Logger,
) {
	if forks == nil || blockNumber == 0 || txn == nil {
		return
	}

	var network string

	switch chainID {
	case DevNetChainID:
		network = devNet
	case MainNetChainID:
		fallthrough
	default:
		network = mainNet
	}

	// only upgrade pre-portland once
	if forks.IsOnPreportland(blockNumber) {
		up, ok := _prePortlandUpgrade[network]
		if ok {
			applySystemContractUpgrade(up, blockNumber, txn, forks,
				logger.With("upgrade", up.UpgradeName, "network", network))
		}
	}

	// only upgrade portland once
	if forks.IsOnPortland(blockNumber) {
		up, ok := _portlandUpgrade[network]
		if ok { // only upgrade network needs to be upgraded
			applySystemContractUpgrade(up, blockNumber, txn, forks,
				logger.With("upgrade", up.UpgradeName, "network", network))
		}
	}

	// only upgrade detroit once
	if forks.IsOnDetroit(blockNumber) {
		up, ok := _detroitUpgrade[network]
		if ok { // only upgrade network needs to be upgraded
			applySystemContractUpgrade(up, blockNumber, txn, forks,
				logger.With("upgrade", up.UpgradeName, "network", network))
		}
	}
}

func applySystemContractUpgrade(
	upgrade *Upgrade,
	blockNumber uint64,
	txn *state.Txn,
	forks *chain.Forks,
	logger hclog.Logger,
) {
	if upgrade == nil {
		logger.Info("Empty upgrade config", "height", blockNumber)

		return
	}

	logger.Info(fmt.Sprintf("Apply upgrade %s at height %d", upgrade.UpgradeName, blockNumber))

	forksInTime := forks.At(blockNumber)

	for _, cfg := range upgrade.Configs {
		logger.Info(fmt.Sprintf("Upgrade contract %s to commit %s", cfg.ContractAddr.String(), cfg.CommitURL))

		// parse hex code
		newContractCode, err := hex.DecodeHex(cfg.Code)
		if err != nil {
			panic(fmt.Errorf("failed to decode new contract code: %w", err))
		}

		// set system contract code
		txn.SetCode(cfg.ContractAddr, newContractCode)

		// initialize system contract storage if necessary
		for k, v := range cfg.DefaultInitStorage {
			txn.SetStorage(cfg.ContractAddr, k, v, &forksInTime)
		}

		// deprecated. Re-set account balance in test cases
		for account, balance := range cfg.Rebalance {
			txn.SetBalance(account, balance)
		}
	}
}
